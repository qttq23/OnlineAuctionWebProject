

<!-- product details card -->
<div class="card mb-2" id="productDetailsCard">
	<div class="card-header">
		Product details
	</div>
	<div class="card-body">
		<div class="card mb-3" style="border: none;">
			<div class="row no-gutters">
				<div class="col-md-8 ">

					<!-- list of images -->
					<div id="productImgContainer" class="carousel slide mr-3 mb-2" data-ride="carousel">

						<!-- Indicators -->
						<ul id = "productImgIndicator" class=" carousel-indicators" >

						</ul>

						<!-- The slideshow -->
						<div id="productImgSlider" class=" carousel-inner " >

						</div>

						<!-- Left and right controls -->
						<a class="carousel-control-prev" href="#productImgContainer" data-slide="prev" >
							<i class="fas fa-chevron-left"></i>
						</a>
						<a class="carousel-control-next" href="#productImgContainer" data-slide="next">
							<i class="fas fa-chevron-right"></i>
						</a>

					</div>

					<!-- list of buttons -->
					<div class="buttons">


						<button class="bidBtn btn btn-primary" onclick="bid();"><i class="fas fa-dollar-sign"></i> Bid</button>

						<button class="addWatchListBtn btn btn-light" title="Add to watch list" onclick="addToWatchList(this)" value="0" id="btnForItem_{{this.product.Id}}"><i class="fas fa-heart"></i> Like</button>

						<button class="historyBtn btn btn-light" onclick="viewHistory()"><i class="fas fa-history"></i> History</button>

						<button class="blockBidderBtn btn btn-light" onclick="blockBidder()" title="Block bidder"><i class="fas fa-ban"></i> <i class="far fa-user"></i></button>
					</div>

				</div>

				<!-- product details -->
				<div class="col-md-4">
					<div class="card" style="border: none;">
						<h5 class="card-title">{{this.product.Name}}</h5>

						<p class="card-text">
							<dl class="row">

								<dt class="col-sm-6">
									<i class="fas fa-dollar-sign"></i> Current price
								</dt>
								<dd class="col-sm-6 text-sm-right">{{cashConvert this.product.Max_Price}}</dd>

								<dt class="col-sm-6">
									<i class="fas fa-shopping-cart"></i> Instant buy
								</dt>
								<dd class="col-sm-6 text-sm-right">
									{{#if this.product.EndPrice}}
									{{cashConvert this.product.EndPrice}}
									{{else}}
									<i class="fas fa-ban" title="Not set"></i>
									{{/if}}
								</dd>

								<dt class="col-sm-4">
									<i class="fas fa-gavel"></i> Seller	
								</dt>
								<dd class="col-sm-8 text-sm-right">
									{{maskenName this.product.OwnerName}}, <a href="#" title="Go to details of points">{{ratePointConvert this.product.OwnerPoint}}</a>
								</dd>



								<dt class="col-sm-5">
									<i class="far fa-user"></i> Bidder
								</dt>
								<dd class="col-sm-7 text-sm-right">
									{{maskenName this.product.BidderName}}, <a href="#" title="Go to details of points">{{ratePointConvert this.product.BidderPoint}}</a>
								</dd>

								<dt class="col-sm-5">
									<i class="fas fa-play"></i> Start
								</dt>

								<dd class="col-sm-7 text-sm-right" >
									{{dmyConvert this.product.StartTime}}
								</dd>

								<dt class="col-sm-5">
									<i class="fas fa-hourglass-end"></i> Finish
								</dt>		

								<dd class="col-sm-7 text-sm-right">
									{{relativeDateTimeConvert this.product.EndTime}}
								</dd>



								<dt class="col-sm-12">
									<i class="fas fa-paperclip"></i> Description
									<button class="btn btn-light" title="Add description" onclick="addDescription()"><i class="fas fa-plus"></i></button>
								</dt>
								<dd class="productDescription col-sm-12">
									{{this.product.Description}}
								</dd>
								<!-- <textarea id="mytextarea">Hello, World!</textarea> -->
							</dl>
						</p>

						<p class="card-text"><small class="text-muted">Last updated 3 mins ago</small>
						</p>					
					</div>
				</div>


			</div>
		</div>

	</div>
</div>

<!-- related products list -->
<div class="card">
	<div class="card-header">
		5 related products
	</div>

	<div class="container-fluid mt-3">

		<div class="relatedProductContainer row flex-nowrap overflow-hidden" id="nearEndProDiv">
			{{#each this.relatedList}}
			<div class="col col-sm-4 mt-2 mb-2">
				<div class="item card h-100" id="item{{Id}}">

					<a class="h-50" href="/product/details?id={{Id}}" title="go to product details">
						<img class="card-img-top h-100"
						src="/images/products/{{Id}}/1.jpg" alt="Image of product {{Name}}">
					</a>

					<div class="card-body h-25">

						<a class="linkToItemDetails" href="/product/details?id={{Id}}" title="go to product details: {{Name}}">
							<h5 class="card-title">{{shortenName Name}}</h5>
						</a>

						<dl class="row">

							<dd class="col-sm-8" title="Price to win instantly">
								<i class="fas fa-shopping-cart"></i> Win price
							</dd>
							<dd class="col-sm-4 text-sm-right" title="Price to win instantly">
								{{#if EndPrice}}
								{{cashConvert EndPrice}}
								{{else}}
								<i class="fas fa-ban" title="Not set"></i>
								{{/if}}
							</dd>

							<dd class="col-12 d-flex flex-row justify-content-between" title="The highest price paying bidder">
								
								<span class="text-wrap text-left">
									<i class="far fa-user"></i> {{maskenName BidderName}}
								</span>
								<span class="text-wrap text-right">{{cashConvert Max_Price}}</span>
							</dd>



							<dd class="col-12 d-flex flex-row justify-content-between">

								<span class="badge badge-secondary text-wrap" title="The date product was uploaded">
									<i class="fas fa-play"></i> {{dmyConvert StartTime}}
								</span>
								<span class="badge badge-primary text-sm-right text-wrap endTimeBadge" title="Time left">
									<i class="fas fa-hourglass-start"></i> <span>{{relativeDateTimeConvert EndTime}}</span>
								</span>
							</dd>



							<dd class="col">
								<div class="badge badge-light badge-lg" title="Number of turns made">
									{{Turn}} turns
								</div>
							</dd>
						</dl>


					</div>

					<!-- list of buttons -->
					<div class="buttons ">
						<button class="addWatchListBtn btn btn-light" title="Add to watch list" onclick="addToWatchList(this)" value="0"><i class="fas fa-heart"></i>
						</button>


					</div>


				</div> 
			</div>

			{{/each}}
		</div>
	</div>
</div>


{{#section 'js'}}
<!-- product images -->
<script type="text/javascript">
	const imgNum = 4;
	const imgList = [`{{this.product.ImageFolder}}/{{this.product.Id}}/1.jpg`,
	`{{this.product.ImageFolder}}/{{this.product.Id}}/2.jpg`,
	`{{this.product.ImageFolder}}/{{this.product.Id}}/3.jpg`,
	`{{this.product.ImageFolder}}/{{this.product.Id}}/4.jpg`];

	$(()=>{

		var imgIndicatorHtml = '';
		var imgSliderHtml = '';
		for(var i=0; i < imgNum; i++){
			let temp = i + 1;
			if(temp == 1){
				imgIndicatorHtml += 
				`<li data-target="#productImgContainer" data-slide-to="${temp}" class="active"></li>`;

				imgSliderHtml +=
				`<div class="carousel-item active">
				<img class="img-fluid" src="${imgList[i]}" alt="" style="height: 400px">
				</div>`;
			}
			else{

				imgIndicatorHtml += 
				`<li data-target="#productImgContainer" data-slide-to="${temp}"></li>`;

				imgSliderHtml +=
				`<div class="carousel-item ">
				<img class="img-fluid" src="${imgList[i]}" alt="" style="height: 400px;">
				</div>`;
			}

		}
		$('#productImgIndicator').html(imgIndicatorHtml);
		$('#productImgSlider').html(imgSliderHtml);

		// set color for indicators and left, right navigation buttons
		$('#productImgIndicator li').css('background-color', 'gray');
		$('.carousel-control-prev i').css('color', 'gray');
		$('.carousel-control-next i').css('color', 'gray');
	});
</script>


<!-- show/hide scroll bar -->
<script type="text/javascript">
	$(()=>{

		// pc mouse enter
		$('.relatedProductContainer').mouseover(function(){
			$(this).removeClass('overflow-hidden');
			$(this).addClass('overflow-auto');

		});

		// mobile mouse enter
		$('.relatedProductContainer').on('touchmove', function(ev) {
			$(this).removeClass('overflow-hidden');
			$(this).addClass('overflow-auto');
		});

		// pc mouse out
		$('.relatedProductContainer').mouseout(function(){
			$(this).removeClass('overflow-auto');
			$(this).addClass('overflow-hidden');

		});

		// mobile mouse out
		$('.relatedProductContainer').on('touchend', function(ev) {
			$(this).removeClass('overflow-hidden');
			$(this).addClass('overflow-auto');
		});
	})
</script>


<!-- highlight nearly end related products -->
<script type="text/javascript" src="/moment/moment.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
<script type="text/javascript">

	$(()=>{

		
	})

	// get list
	var list = [];
	{{#each this.relatedList}}
	list.push(
	{
		Id:{{Id}}, 
		EndTime:'{{EndTime}}',
		Price: '{{Max_Price}}',
	});
	{{/each}}
	// get list done

	// <!-- timer effect for nearly end products -->
	var listNearEnd = [];
	for(let i = 0; i < list.length; i++){

		let remains = remainSeconds(list[i].EndTime);
		if(remains > 0 && remains < 24 * 60 * 60 /*a day*/){

			// red highlight
			$(`#item${list[i].Id} .endTimeBadge`).addClass('badge-danger');

			// counter for less than 5 minutes
			if(remains < 5 * 60){
				listNearEnd.push(list[i]);
				// alert("pushed");
			}

			setTimeout(decreaseEndTime, 1000);
		}
	}


	function decreaseEndTime(){
		console.log('timout');

		// traverse all near end list
		listNearEnd.forEach(item=>{
			let remains = remainSeconds(item.EndTime);
			if(remains > 0){
				// decrease 1 second
				$(`#item${item.Id} .endTimeBadge span`).text('' + remains +' giây nữa');
			}
			else if(remains < 0){

				$(`#item${item.Id} .endTimeBadge span`).text('' + relativeDateTimeConvert(item.EndTime));
				$(`#item${item.Id} .endTimeBadge`).removeClass('badge-danger');



			}
		});

		setTimeout(decreaseEndTime, 1000);
	}
</script>


<!-- rich text editor -->
<script src="https://cdn.tiny.cloud/1/sguks5b8xq72spqc54wfsvdq7harih5jaa1358y1qxuo0cob/tinymce/5/tinymce.min.js"></script>
<script>
	tinymce.init({
		selector: '#mytextarea'
	});
</script>

<!-- bid -->
<script type="text/javascript">
	var price = 500;
	var step = 300;

	function bid(){

		let pro = {
			Id: {{this.product.Id}},
			Name: '{{this.product.Name}}',
			CatId: {{this.product.CatId}},
			// EndTime: '{{dmyConvert this.product.EndTime}}',
			EndTime: '{{this.product.EndTime}}',

			IsRestrictBidder: {{this.product.IsRestrictBidder}},
			PriceStep: {{this.product.PriceStep}},
			Max_Price: {{this.product.Max_Price}},

		};

		let endTime = '{{this.product.EndTime}}';
		if(remainSeconds(endTime) <= 0){
			alert('Product is not available any more :(.');
			return;
		}

		if(isAuthen){

			// ajax request price to server
			$.ajax({
				method: 'post',
				url: '/product/price',
				data: {
					userId: userId,
					pro: pro
				}

			})
			.done(function(json){
				if(json.isOk){

					let price = json.newPrice;

					var sec = 1000;
					Swal.fire({
						position: 'center',
						icon: 'info',
						title: 'System is calculating suggested price',
						showConfirmButton: false,
						timer: sec,
						toast: true
					});

					myVar = setTimeout(()=>{
						let cash_converted = cashConvert(price);
						Swal.fire({
							title: `<div><p style="color:red">${cash_converted}&nbsp;</p>is suggested price. <input id="swal-input-price" class="swal2-input" type="number" value="${price}"></div>`,
							text: " Are you sure to bid? ",
							icon: 'question',
							showCancelButton: true,
							confirmButtonColor: '#3085d6',
							cancelButtonColor: '#d33',
							confirmButtonText: 'Yes, I bid!'
						}).then((result) => {
							if (result.value) {
								// confirm bid
								$.ajax({
									method: 'post',
									url: '/product/bid',
									data: {
										userId: userId,
										pro: pro,
										price: $('#swal-input-price').val()
									},
									async: false
								})
								.done(function(json){
									if(json.isOk){
										// re-fresh page
										window.location.href = json.redirect;

										// add to history
										countHistory++;
										times[countHistory - 1] = 'just 	now';
										bidders[countHistory - 1] = 'You';
										priceds[countHistory - 1] = `${price}`;

										// increase next price
										price += step;



										// show notification
										Swal.fire(
											'Bidded!',
											'Your bid has been made.',
											'success'
											);
									}
									else{
										//show error
										alert(json.msg);
									}
								});

								


							}
						});

						clearTimeout(myVar);
					}, sec);

				}
				else{
					alert(json.msg);
				}
			})

			
		}
		else{
			// show login require notification
			Swal.fire(
				'Login required!',
				'You need to login to use this function',
				'info'
				);

		}

		

		





	}
</script>


<!-- history -->
<script type="text/javascript">

	function viewHistory(){

		// send request history to server
		$.ajax({
			method: 'get',
			url: '/product/history?id={{this.product.Id}}',

		})
		.done(function(json){

			if(json.isOk){

				var trHtml = '';
				for(var i = 0; i < json.history.length; i++){
					let dateCreate_converted = dmyhmsConvert(json.history[i].DateCreate);
					let price_converted = cashConvert(json.history[i].Price);
					let name_masked = maskenName(json.history[i].BidderName);
					trHtml += `
					<tr>
					<td>${dateCreate_converted}</td>
					<td>${name_masked}</td>
					<td>${price_converted}</td>
					</tr>
					`;
				}

				var tableHtml = `
				<table class="historyTable table">
				<thead>
				<tr>

				<th scope="col">Time</th>
				<th scope="col">Bidder</th>
				<th scope="col">Price</th>
				</tr>
				</thead>

				<tbody>
				` +
				trHtml +

				`</tbody>
				</table>`;

				Swal.fire(
					'History',
					tableHtml,
					// 'success'
					);

			}
			else{
				alert('fail to get bid history');
			}
		})


		
	}
</script>

{{/section}}